rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset enforces a security model based on a combination
     * of strict user ownership and collaborative, shared access. User data is private
     * to the individual, while trip data is accessible to a defined group of participants.
     *
     * Data Structure:
     * - /users/{userId}: Private user profile data. Access is restricted to the owner,
     *   but readable by co-participants of a shared trip.
     * - /trips/{tripId}: Shared trip documents. Access is controlled by a denormalized
     *   `participantIds` array within each document.
     * - /trips/{tripId}/messages/{messageId}: Chat messages for a trip. Access is
     *   inherited from the parent trip's participant list.
     *
     * Key Security Decisions:
     * - User privacy is paramount; listing all users' profiles is disallowed. A user
     *   can only read another user's profile if they share a trip.
     * - The `participantIds` array on a trip document is the single source of truth for
     *   authorization, making rules fast and secure without extra reads for list operations.
     * - Any signed-in user can create a trip, but they must include themselves as the
     *   first participant.
     * - Any existing participant of a trip can modify the trip details or add/remove
     *   other participants, fostering a collaborative environment.
     * - Chat messages can only be sent by trip participants, and only the original sender
     *   can edit or delete their own messages.
     *
     * Denormalization for Authorization: Access to `/trips` and their `messages` subcollections
     * is controlled by the `participantIds` array denormalized onto each `/trips/{tripId}` document.
     * This avoids impossible-to-secure queries and slow `get()` calls in list rules, enabling
     * secure and performant queries like `where('participantIds', 'array-contains', userId)`.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     * Used for ownership checks.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document exists and the requesting user is the owner.
     * Used for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Returns true if the requesting user's UID is in the parent trip's `participantIds` list.
     * This performs a `get()` call and is used to secure subcollections.
     */
    function isParentTripParticipant(tripId) {
      let tripDoc = get(/databases/$(database)/documents/trips/$(tripId));
      return isSignedIn() && request.auth.uid in tripDoc.data.participantIds;
    }
    
    /**
     * Checks if the requesting user and the target user share at least one trip.
     * This function is crucial for allowing users to see profile information
     * of their co-travelers without exposing all user data.
     */
    function doUsersShareTrip(targetUserId) {
      // This is a performant and secure way to check for a shared relationship.
      // It relies on a Firestore index on the `participantIds` array.
      return exists(
        /databases/$(database)/documents/trips/{tripId}
        where get(/databases/$(database)/documents/trips/$(tripId)).data.participantIds.hasAll([request.auth.uid, targetUserId])
      );
    }


    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------

    /**
     * @description Manages user profile data.
     * @path /users/{userId}
     * @allow (get) A user can read their own profile, or another user's profile if they share a trip.
     * @allow (create, update, delete) A user can manage their own profile document.
     * @deny  (list) Listing all users is explicitly forbidden for security.
     * @principle Restricts access via ownership, but allows reads for collaborators.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || doUsersShareTrip(userId);
      allow list: if false; // Explicitly deny listing all users.
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId)
                    && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages shared trip documents.
     * @path /trips/{tripId}
     * @allow (list) A signed-in user can list the trips they are a participant of.
     *             (Security is enforced by the client-side query).
     * @allow (get) A user can read the details of a trip they are a participant in.
     * @allow (create) A signed-in user can create a new trip, adding themself as a participant.
     * @allow (update, delete) An existing participant can modify or delete the trip.
     * @deny  (get, update, delete) A user cannot access or modify a trip they are not a part of.
     * @principle Enforces shared access via a denormalized participant list.
     */
    match /trips/{tripId} {
      allow get: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/trips/$(tripId)).data.participantIds;
      allow list: if isSignedIn(); // relies on client-side query `where('participantIds', 'array-contains', user.uid)`
      allow create: if isSignedIn()
                    && request.auth.uid in request.resource.data.participantIds;
      allow update: if isSignedIn() && request.auth.uid in resource.data.participantIds;
      allow delete: if isSignedIn() && request.auth.uid in resource.data.participantIds;
    }

    /**
     * @description Manages chat messages within a trip.
     * @path /trips/{tripId}/messages/{messageId}
     * @allow (get, list) A trip participant can read all messages for that trip.
     * @allow (create) A trip participant can send a new message.
     * @allow (update, delete) A user can update or delete their own messages.
     * @deny  (create) A user who is not a trip participant cannot send a message.
     * @deny  (delete) A user cannot delete another user's message.
     * @principle Inherits authorization from the parent document and enforces ownership for writes.
     */
    match /trips/{tripId}/messages/{messageId} {
      allow get, list: if isParentTripParticipant(tripId);
      allow create: if isParentTripParticipant(tripId)
                    && request.resource.data.tripId == tripId
                    && request.resource.data.senderId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.senderId)
                    && isParentTripParticipant(tripId)
                    && request.resource.data.tripId == resource.data.tripId
                    && request.resource.data.senderId == resource.data.senderId;
      allow delete: if isExistingOwner(resource.data.senderId) && isParentTripParticipant(tripId);
    }
  }
}
